import alert

import os
import pandas as pd
import pytest


dirpath = os.path.dirname(os.path.abspath(__file__))


def path_to_datafile(filename: str) -> str:
    return os.path.join(dirpath, "data", filename)


def df_from_datafile(filename: str) -> pd.DataFrame:
    return pd.read_pickle(path_to_datafile(filename))


def df_with_regressions(expected_regressions: str) -> pd.DataFrame:
    return pd.read_pickle(path_to_datafile(expected_regressions))


@pytest.mark.parametrize(
    "filename, expected_regressions",
    [
        ("outFeb22.pkl", "output-test.pkl"),
    ],
)
def test_find_regressions(filename: str, expected_regressions: str):
    df = df_from_datafile(filename)
    regressions = alert.find_regressions(df)
    regressions_results = df_from_datafile(expected_regressions)

    assert regressions.equals(regressions_results)

# WIP!!!! : 
#def test_analyze_pipeline():
#    results_w_z_regressions = [BenchmarkResultInfo(display_name=\'`frame_methods.ToHTML.time_to_html_mixed` (Python)\', link=\'http://0.0.0.0:5000/compare/benchmarks/065fb8f58c197c9a80009b320d45e7b3...065fb92e26da7b6d800027c32db3fc32\', has_error=False, has_z_regression=True, run_id=\'1c64843d429d480aa3aa76d2d1fddb2d\', run_reason=\'commit\', run_time=\'2024-03-21 01:51:21Z\', run_hardware=\'pandas-benchmarks\', run_link=\'http://0.0.0.0:5000/compare/runs/2ce974b3264145fe9b25e90a47c9a027...1c64843d429d480aa3aa76d2d1fddb2d/\'), BenchmarkResultInfo(display_name="`index_cached_properties.IndexCache.time_engine` (Python) with index_type=\'DatetimeIndex\'", link=\'http://0.0.0.0:5000/compare/benchmarks/065fb8f73df1711e80009efa83f1b4cc...065fb93015fb7f35800097d1afe0896e\', has_error=False, has_z_regression=True, run_id=\'1c64843d429d480aa3aa76d2d1fddb2d\', run_reason=\'commit\', run_time=\'2024-03-21 01:51:21Z\', run_hardware=\'pandas-benchmarks\', run_link=\'http://0.0.0.0:5000/compare/runs/2ce974b3264145fe9b25e90a47c9a027...1c64843d429d480aa3aa76d2d1fddb2d/\'), BenchmarkResultInfo(display_name=\'`timedelta.DatetimeAccessor.time_timedelta_microseconds` (Python)\', link=\'http://0.0.0.0:5000/compare/benchmarks/065fb903532876a480002143dc13fa6b...065fb93fad9779b78000c3331529282e\', has_error=False, has_z_regression=True, run_id=\'1c64843d429d480aa3aa76d2d1fddb2d\', run_reason=\'commit\', run_time=\'2024-03-21 01:51:21Z\', run_hardware=\'pandas-benchmarks\', run_link=\'http://0.0.0.0:5000/compare/runs/2ce974b3264145fe9b25e90a47c9a027...1c64843d429d480aa3aa76d2d1fddb2d/\'), BenchmarkResultInfo(display_name=\'`timedelta.DatetimeAccessor.time_timedelta_days` (Python)\', link=\'http://0.0.0.0:5000/compare/benchmarks/065fb903528d738f80003704ece239e9...065fb93fad0b756680004e9dd7432a71\', has_error=False, has_z_regression=True, run_id=\'1c64843d429d480aa3aa76d2d1fddb2d\', run_reason=\'commit\', run_time=\'2024-03-21 01:51:21Z\', run_hardware=\'pandas-benchmarks\', run_link=\'http://0.0.0.0:5000/compare/runs/2ce974b3264145fe9b25e90a47c9a027...1c64843d429d480aa3aa76d2d1fddb2d/\'), BenchmarkResultInfo(display_name=\'`index_object.Range.time_get_loc_inc` (Python)\', link=\'http://0.0.0.0:5000/compare/benchmarks/065fb8f77fc27c498000aff019ea636a...065fb93087bf76f18000203d11dd8f69\', has_error=False, has_z_regression=True, run_id=\'1c64843d429d480aa3aa76d2d1fddb2d\', run_reason=\'commit\', run_time=\'2024-03-21 01:51:21Z\', run_hardware=\'pandas-benchmarks\', run_link=\'http://0.0.0.0:5000/compare/runs/2ce974b3264145fe9b25e90a47c9a027...1c64843d429d480aa3aa76d2d1fddb2d/\'), BenchmarkResultInfo(display_name=\'`tslibs.offsets.OffestDatetimeArithmetic.time_add_10` (Python) with offset=<BusinessDay>\', link=\'http://0.0.0.0:5000/compare/benchmarks/065fb900bea87117800065ca03c78dfb...065fb93c656d742d8000d4577204dc61\', has_error=False, has_z_regression=True, run_id=\'1c64843d429d480aa3aa76d2d1fddb2d\', run_reason=\'commit\', run_time=\'2024-03-21 01:51:21Z\', run_hardware=\'pandas-benchmarks\', run_link=\'http://0.0.0.0:5000/compare/runs/2ce974b3264145fe9b25e90a47c9a027...1c64843d429d480aa3aa76d2d1fddb2d/\'), BenchmarkResultInfo(display_name=\'`index_object.Range.time_sort_values_asc` (Python)\', link=\'http://0.0.0.0:5000/compare/benchmarks/065fb8f783c376588000bd7bf6426638...065fb9308b9d7d1d8000f0cbb3d44bd6\', has_error=False, has_z_regression=True, run_id=\'1c64843d429d480aa3aa76d2d1fddb2d\', run_reason=\'commit\', run_time=\'2024-03-21 01:51:21Z\', run_hardware=\'pandas-benchmarks\', run_link=\'http://0.0.0.0:5000/compare/runs/2ce974b3264145fe9b25e90a47c9a027...1c64843d429d480aa3aa76d2d1fddb2d/\'), BenchmarkResultInfo(display_name=\'`index_object.Range.time_get_loc_dec` (Python)\', link=\'http://0.0.0.0:5000/compare/benchmarks/065fb8f77f2f751b8000fea5248ea128...065fb93087117b2b800026c979883c8b\', has_error=False, has_z_regression=True, run_id=\'1c64843d429d480aa3aa76d2d1fddb2d\', run_reason=\'commit\', run_time=\'2024-03-21 01:51:21Z\', run_hardware=\'pandas-benchmarks\', run_link=\'http://0.0.0.0:5000/compare/runs/2ce974b3264145fe9b25e90a47c9a027...1c64843d429d480aa3aa76d2d1fddb2d/\'), BenchmarkResultInfo(display_name=\'`timedelta.DatetimeAccessor.time_timedelta_seconds` (Python)\', link=\'http://0.0.0.0:5000/compare/benchmarks/065fb90354167927800036094582f8af...065fb93faeb9797b8000f298aff0f9f4\', has_error=False, has_z_regression=True, run_id=\'1c64843d429d480aa3aa76d2d1fddb2d\', run_reason=\'commit\', run_time=\'2024-03-21 01:51:21Z\', run_hardware=\'pandas-benchmarks\', run_link=\'http://0.0.0.0:5000/compare/runs/2ce974b3264145fe9b25e90a47c9a027...1c64843d429d480aa3aa76d2d1fddb2d/\'), BenchmarkResultInfo(display_name=\'`tslibs.offsets.OffestDatetimeArithmetic.time_subtract` (Python) with offset=<BusinessQuarterEnd: startingMonth=3>\', link=\'http://0.0.0.0:5000/compare/benchmarks/065fb900cf8478ec80007cb7056d8bc9...065fb93c778f73de800055b072ffd99d\', has_error=False, has_z_regression=True, run_id=\'1c64843d429d480aa3aa76d2d1fddb2d\', run_reason=\'commit\', run_time=\'2024-03-21 01:51:21Z\', run_hardware=\'pandas-benchmarks\', run_link=\'http://0.0.0.0:5000/compare/runs/2ce974b3264145fe9b25e90a47c9a027...1c64843d429d480aa3aa76d2d1fddb2d/\'), BenchmarkResultInfo(display_name=\'`tslibs.offsets.OffestDatetimeArithmetic.time_add` (Python) with offset=<QuarterBegin: startingMonth=3>\', link=\'http://0.0.0.0:5000/compare/benchmarks/065fb900af6d76b38000708dafa3b002...065fb93c56c57d9080005484ddab21e5\', has_error=False, has_z_regression=True, run_id=\'1c64843d429d480aa3aa76d2d1fddb2d\', run_reason=\'commit\', run_time=\'2024-03-21 01:51:21Z\', run_hardware=\'pandas-benchmarks\', run_link=\'http://0.0.0.0:5000/compare/runs/2ce974b3264145fe9b25e90a47c9a027...1c64843d429d480aa3aa76d2d1fddb2d/\'), BenchmarkResultInfo(display_name=\'`timedelta.DatetimeAccessor.time_timedelta_nanoseconds` (Python)\', link=\'http://0.0.0.0:5000/compare/benchmarks/065fb903539778dd8000de1dc71e2a61...065fb93fae267a8080000feb39750bea\', has_error=False, has_z_regression=True, run_id=\'1c64843d429d480aa3aa76d2d1fddb2d\', run_reason=\'commit\', run_time=\'2024-03-21 01:51:21Z\', run_hardware=\'pandas-benchmarks\', run_link=\'http://0.0.0.0:5000/compare/runs/2ce974b3264145fe9b25e90a47c9a027...1c64843d429d480aa3aa76d2d1fddb2d/\'), BenchmarkResultInfo(display_name="`timeseries.DatetimeAccessor.time_dt_accessor_normalize` (Python) with t=\'US/Eastern\'", link=\'http://0.0.0.0:5000/compare/benchmarks/065fb8ff7b2678e08000fefae77cffa1...065fb93ac9fa75338000717b4f6ce440\', has_error=False, has_z_regression=True, run_id=\'1c64843d429d480aa3aa76d2d1fddb2d\', run_reason=\'commit\', run_time=\'2024-03-21 01:51:21Z\', run_hardware=\'pandas-benchmarks\', run_link=\'http://0.0.0.0:5000/compare/runs/2ce974b3264145fe9b25e90a47c9a027...1c64843d429d480aa3aa76d2d1fddb2d/\'), BenchmarkResultInfo(display_name=\'`indexing.InsertColumns.time_assign_list_of_columns_concat` (Python)\', link=\'http://0.0.0.0:5000/compare/benchmarks/065fb8f7bfd57daf80001a65d34475f3...065fb930cdbb7d0080001f0f5773cfbb\', has_error=False, has_z_regression=True, run_id=\'1c64843d429d480aa3aa76d2d1fddb2d\', run_reason=\'commit\', run_time=\'2024-03-21 01:51:21Z\', run_hardware=\'pandas-benchmarks\', run_link=\'http://0.0.0.0:5000/compare/runs/2ce974b3264145fe9b25e90a47c9a027...1c64843d429d480aa3aa76d2d1fddb2d/\'), BenchmarkResultInfo(display_name=\'`tslibs.offsets.OffestDatetimeArithmetic.time_subtract_10` (Python) with offset=<YearEnd: month=12>\', link=\'http://0.0.0.0:5000/compare/benchmarks/065fb900e20b733f80009cf9c601cb43...065fb93c8a657cc2800096a40ce88529\', has_error=False, has_z_regression=True, run_id=\'1c64843d429d480aa3aa76d2d1fddb2d\', run_reason=\'commit\', run_time=\'2024-03-21 01:51:21Z\', run_hardware=\'pandas-benchmarks\', run_link=\'http://0.0.0.0:5000/compare/runs/2ce974b3264145fe9b25e90a47c9a027...1c64843d429d480aa3aa76d2d1fddb2d/\'), BenchmarkResultInfo(display_name="`rolling.VariableWindowMethods.time_method` (Python) with constructor=\'DataFrame\', dtype=\'float\', method=\'max\', window=\'50s\'", link=\'http://0.0.0.0:5000/compare/benchmarks/065fb8fd71e27c3b80002b20919c1ba5...065fb93827a878098000288f3d5f2be6\', has_error=False, has_z_regression=True, run_id=\'1c64843d429d480aa3aa76d2d1fddb2d\', run_reason=\'commit\', run_time=\'2024-03-21 01:51:21Z\', run_hardware=\'pandas-benchmarks\', run_link=\'http://0.0.0.0:5000/compare/runs/2ce974b3264145fe9b25e90a47c9a027...1c64843d429d480aa3aa76d2d1fddb2d/\')]
#    commit = "d23f95fda6c3067e61d844aca09aefbde2bdb51e"
#    date = "1710952913000"
#    
#    assert alert.analyze_pipeline(results_w_z_regressions, commit, date) == ""